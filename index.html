<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI英作文練習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .streak-fire {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff7800, 0 0 20px #ff7800, 0 0 25px #ff7800, 0 0 30px #ff7800, 0 0 35px #ff7800;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            visibility: hidden;
            opacity: 0;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition-all duration-200 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tooltip {
            @apply invisible absolute;
        }
        .has-tooltip:hover .tooltip {
            @apply visible z-50;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased">

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h4M5 8h2m4 0h2m-4 4h2m4 0h2"></path></svg>
                        <h1 class="text-xl font-bold">AI英作文練習</h1>
                    </div>
                    <div id="auth-container" class="flex items-center space-x-4"></div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Loading Screen -->
            <div id="screen-loading" class="flex items-center justify-center h-full">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            </div>
            
            <!-- Auth Screen -->
            <div id="screen-auth" class="hidden text-center">
                <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-8">
                    <h2 class="text-2xl font-bold mb-2">AI英作文練習</h2>
                    <p id="auth-version-display" class="text-xs text-gray-500 mb-4"></p>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">学習データを安全に保存・同期するために、Googleアカウントでサインインしてください。</p>
                    <ul class="text-left mb-8 space-y-2 text-gray-600 dark:text-gray-400">
                        <li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>進捗が自動で保存され、どのデバイスからでも学習を再開できます。</span></li>
                        <li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>新しいパスワードを覚える必要はありません。</span></li>
                    </ul>
                    <button id="signin-btn" class="btn btn-primary w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Googleでサインイン
                    </button>
                    <p id="auth-error" class="text-red-500 mt-4 h-5"></p>
                </div>
            </div>

            <!-- LoggedIn Screen -->
            <div id="screen-loggedin" class="hidden">
                <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 text-center">
                   <h2 class="text-2xl font-bold mb-4">ログイン成功！</h2>
                   <p>ようこそ、<span id="loggedin-username" class="font-semibold"></span>さん！</p>
                   <p class="text-sm text-gray-500 mt-2">現在、認証機能のデバッグ中です。</p>
                   <p class="mt-6">この画面が表示されれば、PCとモバイルでのログイン・ログアウト機能は正常に動作しています。</p>
               </div>
            </div>

            <!-- Learning related screens are kept in the DOM but hidden and unused -->
            <div id="screen-main-menu" class="hidden">...</div>
            <div id="screen-quiz" class="hidden">...</div>
            <div id="screen-result" class="hidden">...</div>
            <div id="screen-history" class="hidden">...</div>
            <div id="screen-custom-sets" class="hidden">...</div>
        </main>
        <footer class="text-center text-xs text-gray-400 p-4">
            <p id="version-display"></p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="api-key-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-4">APIキーが必要です</h2>
            <p class="mb-4 text-gray-600 dark:text-gray-400">AI機能を利用するには、Google AI Studioで取得したAPIキーが必要です。キーはあなたのブラウザに安全に保存され、外部に送信されることはありません。</p>
            <input type="password" id="api-key-input" class="w-full p-2 border rounded-lg mb-4 bg-gray-50 dark:bg-gray-700" placeholder="ここにAPIキーを貼り付け">
            <div class="flex justify-end space-x-4">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">キーを取得</a>
                <button id="save-api-key-btn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
    
    <!-- (Settings Modal is removed for simplicity in this version) -->
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- App Version ---
        const APP_VERSION = "3.35.5";

        // --- グローバル変数と状態管理 ---
        let app, auth;
        let currentUser = null;
        let apiKey = null;
        let isFirebaseInitialized = false;
        
        // --- DOM要素 ---
        const screens = {
            loading: document.getElementById('screen-loading'),
            auth: document.getElementById('screen-auth'),
            loggedin: document.getElementById('screen-loggedin'),
        };
        const modals = {
            apiKey: document.getElementById('api-key-modal'),
        };
        
        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`DOM content loaded. Initializing app v${APP_VERSION}...`);
            // Display version
            document.getElementById('version-display').textContent = `v${APP_VERSION}`;
            document.getElementById('auth-version-display').textContent = `v${APP_VERSION}`;

            initFirebase();
            loadApiKey();
            initEventListeners();
            
            if (!isFirebaseInitialized) {
                showScreen('auth');
                const signinBtn = document.getElementById('signin-btn');
                if (signinBtn) {
                    signinBtn.disabled = true;
                    signinBtn.textContent = 'バックエンド接続エラー';
                }
            } else {
                setupAuthObserver();
                showScreen('loading');
            }
            
            if (!apiKey) {
                showModal('apiKey');
            }
        });

        function initFirebase() {
            try {
                // 画像から取得したFirebaseプロジェクト設定
                const firebaseConfig = {
                    apiKey: "AIzaSyCbFhsKdalL867VrkqvalQ_6bliEHFq1qs",
                    authDomain: "english-app-e5b4d.firebaseapp.com",
                    projectId: "english-app-e5b4d",
                    storageBucket: "english-app-e5b4d.appspot.com",
                    messagingSenderId: "482204446370",
                    appId: "1:482204446370:web:cc50237afb7abedae531fb"
                };

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                setPersistence(auth, browserLocalPersistence);
                isFirebaseInitialized = true;
            } catch (error) {
                console.error("Firebaseの初期化に失敗しました:", error);
                isFirebaseInitialized = false;
                const appContainer = document.getElementById('app');
                const errorBanner = document.createElement('div');
                errorBanner.className = 'bg-red-600 text-white p-3 text-center text-sm sticky top-0 z-50';
                errorBanner.innerHTML = `<b>初期化エラー:</b> Firebaseに接続できません。(詳細: ${error.message})`;
                appContainer.prepend(errorBanner);
            }
        }

        function setupAuthObserver() {
            if (!isFirebaseInitialized) return;

            getRedirectResult(auth)
                .then((result) => {
                    if (result) console.log("Redirect result successfully handled.", result.user);
                }).catch((error) => {
                    console.error("Error handling redirect result:", error);
                    document.getElementById('auth-error').textContent = `エラー: ${error.message} (${error.code})`;
                });

             onAuthStateChanged(auth, user => {
                if (user) {
                    if (currentUser && currentUser.uid === user.uid) return;
                    currentUser = user;
                    console.log("User signed in:", user.uid);
                    onLogin();
                } else {
                    onLogout();
                }
            });
        }
        
        // --- 認証 ---
        function onLogin() {
            if (!apiKey) {
                showModal('apiKey');
                showScreen('auth');
                document.getElementById('auth-container').innerHTML = '';
                return;
            }
            showScreen('loading');
            updateHeader();
            document.getElementById('loggedin-username').textContent = currentUser.displayName;
            showScreen('loggedin');
        }

        function onLogout() {
            if(currentUser) console.log("User signed out.");
            currentUser = null;
            updateHeader();
            showScreen('auth');
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function handleSignIn() {
            const provider = new GoogleAuthProvider();
            const signinMethod = isMobile() ? signInWithRedirect : signInWithPopup;
            
            const signinBtn = document.getElementById('signin-btn');
            const authErrorEl = document.getElementById('auth-error');
            signinBtn.disabled = true;
            signinBtn.innerHTML = `<div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5 mr-2"></div> 処理中...`;
            authErrorEl.textContent = '';

            signinMethod(auth, provider)
                .catch(error => {
                    console.error("Sign in error:", error);
                    let message = "サインインに失敗しました。";
                    if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                        message = "認証がキャンセルされました。";
                    } else if (error.code === 'auth/network-request-failed') {
                        message = "ネットワーク接続を確認してください。";
                    }
                    authErrorEl.textContent = message;
                })
                .finally(() => {
                    signinBtn.disabled = false;
                     signinBtn.innerHTML = `<svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg> Googleでサインイン`;
                });
        }
        
        function handleSignOut() {
            signOut(auth).catch(error => console.error("Sign out error", error));
        }

        // --- UI更新 ---
        function showScreen(screenId) {
            Object.keys(screens).forEach(key => {
                if(screens[key]) screens[key].classList.add('hidden');
            });
            if (screens[screenId]) {
                screens[screenId].classList.remove('hidden');
            }
        }
        
        function showModal(modalId) {
            if (modals[modalId]) modals[modalId].classList.remove('hidden');
        }

        function hideModal(modalId) {
            if (modals[modalId]) modals[modalId].classList.add('hidden');
        }

        function updateHeader() {
            const container = document.getElementById('auth-container');
            if (currentUser) {
                container.innerHTML = `
                    <div class="has-tooltip relative">
                        <img src="${currentUser.photoURL || 'https://placehold.co/40x40/E2E8F0/4A5568?text=User'}" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer">
                        <div class="tooltip -left-8 mt-2 w-auto p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg">
                            UID: ${currentUser.uid}
                        </div>
                    </div>
                    <button id="signout-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                `;
                document.getElementById('signout-btn').onclick = handleSignOut;
            } else {
                container.innerHTML = '';
            }
        }
        
        // --- APIキー管理 ---
        function loadApiKey() {
            apiKey = localStorage.getItem('geminiApiKey');
        }
        
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                hideModal('apiKey');
                if (auth.currentUser) {
                   onLogin();
                } else if(isFirebaseInitialized) {
                    showScreen('auth');
                }
            } else {
                alert('APIキーを入力してください。');
            }
        }
        
        // --- イベントリスナー ---
        function initEventListeners() {
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            document.getElementById('save-api-key-btn').addEventListener('click', saveApiKey);
            document.getElementById('api-key-input').addEventListener('keypress', (e) => e.key === 'Enter' && saveApiKey());
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‹±ä½œæ–‡ç·´ç¿’ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .streak-fire {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff7800, 0 0 20px #ff7800, 0 0 25px #ff7800, 0 0 30px #ff7800, 0 0 35px #ff7800;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            visibility: hidden;
            opacity: 0;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition-all duration-200 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tooltip {
            @apply invisible absolute;
        }
        .has-tooltip:hover .tooltip {
            @apply visible z-50;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased">

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h4M5 8h2m4 0h2m-4 4h2m4 0h2"></path></svg>
                        <h1 class="text-xl font-bold">AIè‹±ä½œæ–‡ç·´ç¿’</h1>
                    </div>
                    <div id="auth-container" class="flex items-center space-x-4"></div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Loading Screen -->
            <div id="screen-loading" class="flex items-center justify-center h-full">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            </div>
            
            <!-- Auth Screen -->
            <div id="screen-auth" class="hidden text-center">
                <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-8">
                    <h2 class="text-2xl font-bold mb-4">ã‚ˆã†ã“ãï¼</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ä¿å­˜ãƒ»åŒæœŸã™ã‚‹ãŸã‚ã«ã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                    <ul class="text-left mb-8 space-y-2 text-gray-600 dark:text-gray-400">
                        <li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>é€²æ—ãŒè‡ªå‹•ã§ä¿å­˜ã•ã‚Œã€ã©ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã§ã‚‚å­¦ç¿’ã‚’å†é–‹ã§ãã¾ã™ã€‚</span></li>
                        <li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦šãˆã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</span></li>
                    </ul>
                    <button id="signin-btn" class="btn btn-primary w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                    </button>
                    <p id="auth-error" class="text-red-500 mt-4 h-5"></p>
                </div>
            </div>

            <!-- Main Menu Screen -->
            <div id="screen-main-menu" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Stats Card -->
                    <div class="md:col-span-2 lg:col-span-3 bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                        <h3 class="font-bold text-lg mb-4">å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                        <div id="stats-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center"></div>
                    </div>
                    <!-- Mode Selection -->
                    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-xl mb-2">ä»Šæ—¥ã®å¾©ç¿’</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">è¨˜æ†¶ã®å®šç€ã«æœ€ã‚‚åŠ¹æœçš„ãªå•é¡Œã‚’SRSãŒè‡ªå‹•ã§é¸ã³å‡ºã—ã¾ã™ã€‚</p>
                        <button id="review-btn" class="btn btn-primary w-full">å¾©ç¿’ã‚’é–‹å§‹</button>
                        <div id="review-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-xl mb-2">æ–°ã—ã„å•é¡Œã‚’å­¦ã¶</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">ã¾ã å­¦ç¿’ã—ã¦ã„ãªã„å•é¡Œã«æŒ‘æˆ¦ã—ã¦ã€è¡¨ç¾ã®å¹…ã‚’åºƒã’ã¾ã—ã‚‡ã†ã€‚</p>
                        <button id="new-question-btn" class="btn btn-primary w-full">å­¦ç¿’ã‚’é–‹å§‹</button>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-xl mb-2">ã‚«ã‚¹ã‚¿ãƒ å•é¡Œé›†</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">è‡ªåˆ†ã§ä½œæˆã—ãŸå•é¡Œé›†ã§ã€ç‰¹å®šã®åˆ†é‡ã‚’é›†ä¸­çš„ã«å­¦ç¿’ã—ã¾ã™ã€‚</p>
                        <button id="custom-sets-btn" class="btn btn-primary w-full">å•é¡Œé›†ã‚’ç®¡ç†</button>
                    </div>
                     <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-xl mb-2">å…¨å›ç­”å±¥æ­´</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">éå»ã®å›ç­”ã‚’è¦‹è¿”ã—ã€é–“é•ã„ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã—ã‚‡ã†ã€‚</p>
                        <button id="history-btn" class="btn btn-primary w-full">å±¥æ­´ã‚’è¦‹ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- Quiz Screen -->
            <div id="screen-quiz" class="hidden">
                 <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-4">
                        <p id="quiz-progress" class="text-sm text-gray-500"></p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="quiz-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                        <div class="mb-6 text-center">
                            <p class="text-lg text-gray-500 dark:text-gray-400 mb-2">ä»¥ä¸‹ã®æ—¥æœ¬èªã‚’è‹±è¨³ã—ã¦ãã ã•ã„:</p>
                            <h2 id="japanese-question" class="text-2xl md:text-3xl font-bold"></h2>
                        </div>
                        <div class="relative">
                            <textarea id="answer-textarea" rows="4" class="w-full p-4 pr-12 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›..."></textarea>
                            <button id="mic-btn" class="absolute top-1/2 right-4 -translate-y-1/2 text-gray-500 hover:text-blue-600">
                                <svg id="mic-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z"></path></svg>
                                <svg id="mic-recording-icon" class="w-6 h-6 text-red-500 hidden animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z"></path></svg>
                            </button>
                        </div>
                        <div class="mt-6 flex flex-col sm:flex-row gap-4">
                           <button id="submit-answer-btn" class="btn btn-primary w-full sm:w-auto flex-grow">å›ç­”ã‚’é€ä¿¡</button>
                           <button id="quit-quiz-btn" class="btn btn-secondary w-full sm:w-auto">ä¸­æ–­ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="screen-result" class="hidden">
                <div class="max-w-3xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                    <!-- Loading Result -->
                    <div id="result-loading" class="text-center">
                        <div class="flex justify-center items-center mb-4">
                           <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
                        </div>
                        <p class="text-xl font-semibold animate-pulse">AIãŒæ¡ç‚¹ä¸­ã§ã™...</p>
                        <p id="english-tip" class="mt-4 text-gray-500 dark:text-gray-400"></p>
                    </div>
                    <!-- Display Result -->
                    <div id="result-display" class="hidden">
                        <div id="result-header" class="text-center mb-6 p-4 rounded-lg">
                            <h2 id="result-title" class="text-3xl font-bold"></h2>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-gray-500 dark:text-gray-400">åŸæ–‡ (æ—¥æœ¬èª)</h4>
                                <p id="result-japanese" class="p-2 bg-gray-100 dark:bg-gray-700 rounded"></p>
                            </div>
                             <div>
                                <h4 class="font-bold text-gray-500 dark:text-gray-400">ã‚ãªãŸã®å›ç­”</h4>
                                <p id="result-user-answer" class="p-2 bg-gray-100 dark:bg-gray-700 rounded"></p>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-500 dark:text-gray-400">æ¨¡ç¯„è§£ç­”</h4>
                                <p id="result-model-answer" class="p-2 bg-gray-100 dark:bg-gray-700 rounded"></p>
                            </div>
                             <div>
                                <h4 class="font-bold text-gray-500 dark:text-gray-400">AIã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                                <div id="result-feedback" class="p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg whitespace-pre-wrap"></div>
                            </div>
                        </div>

                        <!-- AI Chat -->
                        <div id="ai-chat-section" class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                AIã«è³ªå•ã™ã‚‹
                            </h3>
                            <div id="chat-messages" class="h-48 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900 rounded-lg mb-4 border border-gray-200 dark:border-gray-700"></div>
                            <div class="flex items-center gap-2">
                                <input id="chat-input" type="text" placeholder="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã¤ã„ã¦è³ªå•..." class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <button id="chat-send-btn" class="btn btn-primary">é€ä¿¡</button>
                                <button id="chat-mic-btn" class="p-2.5 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500">
                                    <svg id="chat-mic-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"></path><path fill-rule="evenodd" d="M7 7V4a3 3 0 015.958-1L13 3a1 1 0 11-2 0v4a1 1 0 01-2 0V4a1 1 0 10-2 0v3a1 1 0 01-1-1z" clip-rule="evenodd"></path><path d="M10 12.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z"></path></svg>
                                    <svg id="chat-mic-recording-icon" class="w-5 h-5 text-red-500 hidden animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"></path><path fill-rule="evenodd" d="M7 7V4a3 3 0 015.958-1L13 3a1 1 0 11-2 0v4a1 1 0 01-2 0V4a1 1 0 10-2 0v3a1 1 0 01-1-1z" clip-rule="evenodd"></path><path d="M10 12.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- SRS Level Control -->
                        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6 text-center">
                            <p class="mb-2 font-semibold">ã“ã®å•é¡Œã®ç¿’ç†Ÿåº¦ã‚’æ•™ãˆã¦ãã ã•ã„</p>
                            <div class="flex justify-center items-center gap-4">
                                <button data-level-change="-1" class="srs-level-btn btn btn-danger">ã¾ã è‹¦æ‰‹...</button>
                                <span id="srs-level-indicator" class="font-bold text-lg"></span>
                                <button data-level-change="1" class="srs-level-btn btn btn-success">ç°¡å˜ã ã£ãŸï¼</button>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end">
                            <button id="next-question-btn-result" class="btn btn-primary">æ¬¡ã®å•é¡Œã¸</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Screen -->
            <div id="screen-history" class="hidden">
                 <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                       <h2 class="text-2xl font-bold">å…¨å›ç­”å±¥æ­´</h2>
                        <button id="back-to-menu-from-history" class="btn btn-secondary">æˆ»ã‚‹</button>
                    </div>
                    <div class="mb-4 flex items-center gap-4">
                        <label for="history-filter" class="font-semibold">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                        <select id="history-filter" class="p-2 border rounded-lg bg-white dark:bg-gray-700">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="correct">æ­£è§£ã®ã¿</option>
                            <option value="incorrect">ä¸æ­£è§£ã®ã¿</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æ™‚</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å•é¡Œ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚ãªãŸã®å›ç­”</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çµæœ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- Custom Sets Screen -->
            <div id="screen-custom-sets" class="hidden">
                 <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                       <h2 class="text-2xl font-bold">ã‚«ã‚¹ã‚¿ãƒ å•é¡Œé›†ã®ç®¡ç†</h2>
                        <button id="back-to-menu-from-custom-sets" class="btn btn-secondary">æˆ»ã‚‹</button>
                    </div>

                    <!-- Upload Form -->
                    <div class="mb-8 p-6 border rounded-lg bg-gray-50 dark:bg-gray-900/50">
                        <h3 class="text-xl font-semibold mb-4">æ–°ã—ã„å•é¡Œé›†ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                         <div class="flex flex-col sm:flex-row gap-4">
                            <input id="custom-set-title" type="text" placeholder="å•é¡Œé›†ã®ã‚¿ã‚¤ãƒˆãƒ«" class="flex-grow p-2 border rounded-lg bg-white dark:bg-gray-700">
                            <input id="csv-file-input" type="file" accept=".csv" class="w-full sm:w-auto file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                         </div>
                         <p class="text-sm text-gray-500 mt-2">å½¢å¼: CSVãƒ•ã‚¡ã‚¤ãƒ«ã€1è¡Œã«ã€Œæ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ,è‹±èªãƒ†ã‚­ã‚¹ãƒˆã€</p>
                         <button id="upload-csv-btn" class="btn btn-primary mt-4">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                         <p id="upload-status" class="mt-2 h-5 text-green-600 dark:text-green-400"></p>
                    </div>

                    <!-- Set List -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">ã‚ãªãŸã®å•é¡Œé›†</h3>
                        <div id="custom-set-list" class="space-y-4">
                            <!-- List items will be inserted here -->
                        </div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-4">APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</h2>
            <p class="mb-4 text-gray-600 dark:text-gray-400">AIæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€Google AI Studioã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ã‚­ãƒ¼ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <input type="password" id="api-key-input" class="w-full p-2 border rounded-lg mb-4 bg-gray-50 dark:bg-gray-700" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘">
            <div class="flex justify-end space-x-4">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">ã‚­ãƒ¼ã‚’å–å¾—</a>
                <button id="save-api-key-btn" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-6">è¨­å®š</h2>
            <div class="space-y-6">
                <div>
                    <label for="max-questions" class="block mb-2 font-medium">1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®æœ€å¤§å•é¡Œæ•°</label>
                    <input type="number" id="max-questions" min="5" max="100" step="5" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                </div>
                <div>
                    <label for="question-order" class="block mb-2 font-medium">æ–°è¦å•é¡Œã®å‡ºé¡Œé †åº</label>
                    <select id="question-order" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
                        <option value="file">ãƒ•ã‚¡ã‚¤ãƒ«é †</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-medium">éŸ³å£°èª­ã¿ä¸Šã’</label>
                    <label class="inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="speech-toggle" class="sr-only peer">
                      <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                      <span class="ms-3 text-sm font-medium">å•é¡Œæ–‡ã®æ—¥æœ¬èªã‚’è‡ªå‹•ã§èª­ã¿ä¸Šã’ã‚‹</span>
                    </label>
                </div>
                 <div>
                    <button id="reset-api-key-btn" class="btn btn-danger w-full">APIã‚­ãƒ¼ã‚’å†è¨­å®š</button>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button id="close-settings-btn" class="btn btn-primary">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, writeBatch, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- å®šæ•°ã¨è¨­å®š ---
        const MASTERED_LEVEL = 6;
        const REVIEW_INTERVALS = [1, 2, 4, 7, 14, 30, 90, 180, 365]; // days
        const DEFAULT_SETTINGS = {
            maxQuestions: 20,
            questionOrder: 'random',
            speechEnabled: true,
        };
        const englishTips = [
            "ãƒ’ãƒ³ãƒˆ: å† è© (a, an, the) ã®ä½¿ã„æ–¹ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚",
            "ãƒ’ãƒ³ãƒˆ: å˜æ•°å½¢ã¨è¤‡æ•°å½¢ã‚’æ­£ã—ãä½¿ã„åˆ†ã‘ã¾ã—ã‚‡ã†ã€‚",
            "ãƒ’ãƒ³ãƒˆ: æ™‚åˆ¶ã¯æ–‡è„ˆã«åˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
            "ãƒ’ãƒ³ãƒˆ: å‰ç½®è© (in, on, at) ã¯ã‚ˆãã‚ã‚‹é–“é•ã„ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚",
            "ãƒ’ãƒ³ãƒˆ: ä¸»èªã¨å‹•è©ã¯ä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ (e.g., He walks, They walk)",
        ];
        const defaultSentences = [
            ["ã“ã‚Œã¯ãƒšãƒ³ã§ã™ã€‚", "This is a pen."],
            ["ç§ã®åå‰ã¯å¥ã§ã™ã€‚", "My name is Ken."],
            ["ã‚ãªãŸã¯å­¦ç”Ÿã§ã™ã‹ï¼Ÿ", "Are you a student?"],
            ["ç§ã¯æ¯æ—¥è‹±èªã‚’å‹‰å¼·ã—ã¾ã™ã€‚", "I study English every day."],
            ["å½¼ã¯æ˜¨æ—¥å…¬åœ’ã«è¡Œãã¾ã—ãŸã€‚", "He went to the park yesterday."],
            ["å½¼å¥³ã¯æ‰‹ç´™ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚", "She is writing a letter."],
            ["ç§ãŸã¡ã¯æ¥é€±ã€äº¬éƒ½ã‚’è¨ªã‚Œã‚‹äºˆå®šã§ã™ã€‚", "We are going to visit Kyoto next week."],
            ["ã“ã®æœ¬ã¯ã¨ã¦ã‚‚é¢ç™½ã„ã§ã™ã€‚", "This book is very interesting."],
            ["çª“ã‚’é–‹ã‘ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ", "May I open the window?"],
            ["å½¼ã¯ç§ã‚ˆã‚ŠèƒŒãŒé«˜ã„ã§ã™ã€‚", "He is taller than me."],
            ["ä¸–ç•Œã§æœ€ã‚‚é«˜ã„å±±ã¯ä½•ã§ã™ã‹ï¼Ÿ", "What is the highest mountain in the world?"],
            ["ã‚‚ã—ç§ãŒã‚ãªãŸãªã‚‰ã€ãã®ä»•äº‹ã‚’å¼•ãå—ã‘ã‚‹ã§ã—ã‚‡ã†ã€‚", "If I were you, I would take the job."],
            ["ç§ã¯å½¼ãŒæ­£ç›´ã ã¨ã¯æ€ã„ã¾ã›ã‚“ã€‚", "I don't think that he is honest."],
            ["ãã®çŸ¥ã‚‰ã›ã‚’èã„ã¦ã€ç§ã¯é©šãã¾ã—ãŸã€‚", "I was surprised to hear the news."],
            ["è‹±èªã‚’è©±ã™ã“ã¨ã¯é›£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚", "It is not difficult to speak English."],
        ];
        
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨çŠ¶æ…‹ç®¡ç† ---
        let app, auth, db;
        let currentUser = null;
        let userProfileUnsubscribe = null;
        let questionStatsUnsubscribe = null;
        let historyUnsubscribe = null;
        let customSetsUnsubscribe = null;

        let state = {
            apiKey: null,
            settings: { ...DEFAULT_SETTINGS },
            currentQuiz: {
                questions: [],
                currentIndex: 0,
                mode: null,
            },
            questionStats: new Map(), // japanese -> {level, nextReviewDate, ...}
            allHistory: [],
            customSets: [],
            conversationContext: null,
            isMicRecording: false,
            isChatMicRecording: false,
        };
        
        // --- DOMè¦ç´  ---
        const screens = {
            loading: document.getElementById('screen-loading'),
            auth: document.getElementById('screen-auth'),
            mainMenu: document.getElementById('screen-main-menu'),
            quiz: document.getElementById('screen-quiz'),
            result: document.getElementById('screen-result'),
            history: document.getElementById('screen-history'),
            customSets: document.getElementById('screen-custom-sets'),
        };
        const modals = {
            apiKey: document.getElementById('api-key-modal'),
            settings: document.getElementById('settings-modal'),
        };
        
        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing app...");
            initFirebase();
            loadSettings();
            loadApiKey();
            initEventListeners();
            showScreen('loading');
            
            if (!state.apiKey) {
                showModal('apiKey');
            }
        });

        function initFirebase() {
            try {
                // The execution environment is expected to provide __firebase_config
                if (typeof __firebase_config === 'undefined' || !__firebase_config.trim()) {
                    throw new Error("Firebase configuration variable (__firebase_config) is not available or is empty.");
                }

                const firebaseConfig = JSON.parse(__firebase_config);

                // Basic validation of the parsed config object
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("The provided Firebase configuration is missing essential properties like apiKey or projectId.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setPersistence(auth, browserLocalPersistence); // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–
                setupAuthObserver();
            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                const loadingScreen = document.getElementById('screen-loading');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div class="text-center p-6 bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 rounded-lg max-w-lg mx-auto">
                            <h2 class="text-xl font-bold mb-2">ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                            <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¿…è¦ãªè¨­å®šã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
                            <p class="mt-4 text-sm bg-red-100 dark:bg-red-800/30 p-2 rounded">
                                <strong>æŠ€è¡“çš„ãªè©³ç´°:</strong> ${error.message}
                            </p>
                        </div>
                    `;
                }
            }
        }

        function setupAuthObserver() {
             // Handle the result of the redirect sign-in
            getRedirectResult(auth)
                .then((result) => {
                    if (result) {
                        // This confirms the redirect result has been handled.
                        // onAuthStateChanged will now fire with the user.
                        console.log("Redirect result successfully handled.", result.user);
                    }
                }).catch((error) => {
                    // Handle Errors here.
                    console.error("Error handling redirect result:", error);
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    document.getElementById('auth-error').textContent = `ã‚¨ãƒ©ãƒ¼: ${errorMessage} (${errorCode})`;
                });

             onAuthStateChanged(auth, user => {
                if (user) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹
                    if (currentUser && currentUser.uid === user.uid) return; // æ—¢ã«å‡¦ç†æ¸ˆã¿
                    currentUser = user;
                    console.log("User signed in:", user.uid);
                    onLogin();
                } else {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸ
                    if (!currentUser) return; // æ—¢ã«å‡¦ç†æ¸ˆã¿
                    console.log("User signed out.");
                    onLogout();
                }
            });
        }
        
        // --- èªè¨¼ ---
        async function onLogin() {
            if (!state.apiKey) {
                showModal('apiKey');
                showScreen('auth'); // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã¯éš ã™
                document.getElementById('auth-container').innerHTML = '';
                return;
            }
            showScreen('loading');
            updateHeader();
            await setupUser();
            showScreen('mainMenu');
        }

        function onLogout() {
            currentUser = null;
            cleanupListeners();
            state.questionStats.clear();
            state.allHistory = [];
            state.customSets = [];
            updateHeader();
            showScreen('auth');
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function handleSignIn() {
            const provider = new GoogleAuthProvider();
            const signinMethod = isMobile() ? signInWithRedirect : signInWithPopup;
            
            const signinBtn = document.getElementById('signin-btn');
            const authErrorEl = document.getElementById('auth-error');
            signinBtn.disabled = true;
            signinBtn.innerHTML = `<div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5 mr-2"></div> å‡¦ç†ä¸­...`;
            authErrorEl.textContent = '';

            signinMethod(auth, provider)
                .catch(error => {
                    console.error("Sign in error:", error);
                    let message = "ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                        message = "èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚";
                    } else if (error.code === 'auth/network-request-failed') {
                        message = "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                    }
                    authErrorEl.textContent = message;
                })
                .finally(() => {
                    signinBtn.disabled = false;
                     signinBtn.innerHTML = `<svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg> Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³`;
                });
        }
        
        function handleSignOut() {
            signOut(auth).catch(error => console.error("Sign out error", error));
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† (Firestore) ---
        async function setupUser() {
            const userRef = doc(db, 'users', currentUser.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    profile: {
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL,
                        createdAt: serverTimestamp(),
                        lastLoginDate: "",
                        streakCount: 0,
                    }
                });
            }
            
            updateStreak();
            cleanupListeners(); // Start with a clean slate
            setupRealtimeListeners();
        }

        function cleanupListeners() {
            if (userProfileUnsubscribe) userProfileUnsubscribe();
            if (questionStatsUnsubscribe) questionStatsUnsubscribe();
            if (historyUnsubscribe) historyUnsubscribe();
            if (customSetsUnsubscribe) customSetsUnsubscribe();
        }

        function setupRealtimeListeners() {
            const userRef = doc(db, 'users', currentUser.uid);
            
            // Profile Listener (for streak)
            userProfileUnsubscribe = onSnapshot(userRef, (doc) => {
                const profile = doc.data()?.profile;
                if (profile && profile.streakCount !== undefined) {
                    updateStreakUI(profile.streakCount);
                }
            });

            // Question Stats Listener
            const statsCol = collection(db, `users/${currentUser.uid}/questionStats`);
            questionStatsUnsubscribe = onSnapshot(statsCol, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    state.questionStats.set(doc.id, { id: doc.id, ...doc.data() });
                });
                updateStats();
            });

            // History Listener
            const historyCol = collection(db, `users/${currentUser.uid}/history`);
            const historyQuery = query(historyCol, where('timestamp', '!=', null));
            historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                state.allHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateHistoryScreen(); // If history screen is active
            });
            
            // Custom Sets Listener
            const setsCol = collection(db, `users/${currentUser.uid}/problemSets`);
            customSetsUnsubscribe = onSnapshot(setsCol, (snapshot) => {
                state.customSets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCustomSetList(); // If custom set screen is active
            });
        }

        async function updateStreak() {
            const userRef = doc(db, 'users', currentUser.uid);
            const userDoc = await getDoc(userRef);
            const profile = userDoc.data()?.profile || {};

            const today = new Date().toLocaleDateString('sv'); // YYYY-MM-DD
            const lastLogin = profile.lastLoginDate;

            if (lastLogin === today) return; // Already logged in today

            const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('sv');
            let newStreak = 1;
            if (lastLogin === yesterday) {
                newStreak = (profile.streakCount || 0) + 1;
            }

            await updateDoc(userRef, {
                "profile.lastLoginDate": today,
                "profile.streakCount": newStreak
            });
        }
        
        async function saveAnswer(question, userAnswer, result) {
            const batch = writeBatch(db);
            const now = new Date();

            // 1. Update question stat
            const statRef = doc(db, `users/${currentUser.uid}/questionStats`, question.japanese);
            const currentStat = state.questionStats.get(question.japanese) || {
                level: 0,
                attemptCount: 0,
                correctCount: 0,
            };
            
            const newLevel = result.isCorrect 
                ? Math.min(currentStat.level + 1, REVIEW_INTERVALS.length -1) 
                : Math.max(0, currentStat.level - 1);
                
            const nextReviewDate = new Date(now);
            nextReviewDate.setDate(now.getDate() + REVIEW_INTERVALS[newLevel]);

            const newStat = {
                level: newLevel,
                nextReviewDate: Timestamp.fromDate(nextReviewDate),
                lastAttemptDate: Timestamp.fromDate(now),
                attemptCount: (currentStat.attemptCount || 0) + 1,
                correctCount: (currentStat.correctCount || 0) + (result.isCorrect ? 1 : 0),
                japanese: question.japanese,
                english: question.english
            };
            batch.set(statRef, newStat, { merge: true });

            // 2. Add to history
            const historyRef = doc(collection(db, `users/${currentUser.uid}/history`));
            batch.set(historyRef, {
                timestamp: serverTimestamp(),
                japanese: question.japanese,
                userAnswer: userAnswer,
                modelAnswer: question.english,
                isCorrect: result.isCorrect,
                feedback: result.feedback,
            });

            await batch.commit();
        }

        async function updateSrsLevel(question, levelChange) {
            const statRef = doc(db, `users/${currentUser.uid}/questionStats`, question.japanese);
            const currentStat = state.questionStats.get(question.japanese);
            if (!currentStat) return;
            
            const newLevel = Math.max(0, Math.min(currentStat.level + levelChange, REVIEW_INTERVALS.length - 1));
            
            if (newLevel === currentStat.level) return;

            const now = new Date();
            const nextReviewDate = new Date(now);
            nextReviewDate.setDate(now.getDate() + REVIEW_INTERVALS[newLevel]);
            
            await updateDoc(statRef, {
                level: newLevel,
                nextReviewDate: Timestamp.fromDate(nextReviewDate)
            });
            
            // Update local state immediately for UI responsiveness
            state.questionStats.set(question.japanese, { ...currentStat, level: newLevel });
            updateSrsLevelIndicator(newLevel);
        }

        // --- UIæ›´æ–° ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenId]) {
                screens[screenId].classList.remove('hidden');
            }
        }
        
        function showModal(modalId) {
            if (modals[modalId]) {
                modals[modalId].classList.remove('hidden');
            }
        }

        function hideModal(modalId) {
            if (modals[modalId]) {
                modals[modalId].classList.add('hidden');
            }
        }

        function updateHeader() {
            const container = document.getElementById('auth-container');
            if (currentUser) {
                container.innerHTML = `
                    <div id="streak-counter" class="flex items-center font-bold text-orange-500"></div>
                    <div class="has-tooltip relative">
                        <img src="${currentUser.photoURL || 'https://placehold.co/40x40/E2E8F0/4A5568?text=User'}" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer" id="avatar-btn">
                        <div class="tooltip -left-8 mt-2 w-auto p-2 bg-gray-700 text-white text-xs rounded-md shadow-lg">
                            UID: ${currentUser.uid}
                        </div>
                    </div>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    <button id="signout-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                `;
                document.getElementById('signout-btn').onclick = handleSignOut;
                document.getElementById('settings-btn').onclick = () => showModal('settings');
            } else {
                container.innerHTML = ''; // No sign-in button here, handled by screen-auth
            }
        }
        
        function updateStreakUI(streak) {
            const container = document.getElementById('streak-counter');
            if (streak > 0) {
                container.innerHTML = `<span class="streak-fire text-2xl mr-1">ğŸ”¥</span> ${streak}æ—¥é€£ç¶š`;
            } else {
                container.innerHTML = ``;
            }
        }
        
        function updateStats() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            let learning = 0;
            let mastered = 0;
            let dueForReview = 0;
            
            for (const stat of state.questionStats.values()) {
                if (stat.level >= MASTERED_LEVEL) {
                    mastered++;
                } else {
                    learning++;
                    if (stat.nextReviewDate && stat.nextReviewDate.toDate() <= todayStart) {
                        dueForReview++;
                    }
                }
            }
            
            const totalCustomQuestions = state.customSets.reduce((sum, set) => sum + (set.questions?.length || 0), 0);
            const totalQuestions = defaultSentences.length + totalCustomQuestions;
            
            document.getElementById('stats-container').innerHTML = `
                <div><p class="text-3xl font-bold">${learning}</p><p class="text-sm text-gray-500">å­¦ç¿’ä¸­</p></div>
                <div><p class="text-3xl font-bold text-green-500">${mastered}</p><p class="text-sm text-gray-500">ç¿’å¾—æ¸ˆã¿</p></div>
                <div><p class="text-3xl font-bold text-blue-500">${dueForReview}</p><p class="text-sm text-gray-500">ä»Šæ—¥å¾©ç¿’</p></div>
                <div><p class="text-3xl font-bold">${totalQuestions}</p><p class="text-sm text-gray-500">å…¨å•é¡Œæ•°</p></div>
            `;
            
            const reviewBtn = document.getElementById('review-btn');
            const reviewBadge = document.getElementById('review-badge');
            reviewBtn.disabled = dueForReview === 0;
            if(dueForReview > 0) {
                reviewBadge.textContent = dueForReview;
                reviewBadge.classList.remove('hidden');
            } else {
                reviewBadge.classList.add('hidden');
            }
        }

        // --- ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ ---
        function startQuiz(mode, customSetId = null) {
            let questions = [];
            if (mode === 'review') {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                questions = [...state.questionStats.values()]
                    .filter(stat => stat.level < MASTERED_LEVEL && stat.nextReviewDate && stat.nextReviewDate.toDate() <= todayStart)
                    .map(stat => ({ japanese: stat.japanese, english: stat.english }));
            } else if (mode === 'new') {
                const learnedJapanese = new Set(state.questionStats.keys());
                questions = defaultSentences
                    .filter(q => !learnedJapanese.has(q[0]))
                    .map(q => ({ japanese: q[0], english: q[1] }));
                
                if (state.settings.questionOrder === 'random') {
                    questions.sort(() => Math.random() - 0.5);
                }
            } else if (mode === 'custom' && customSetId) {
                const selectedSet = state.customSets.find(s => s.id === customSetId);
                if(selectedSet && selectedSet.questions) {
                    questions = selectedSet.questions.map(q => ({ japanese: q.japanese, english: q.english}));
                }
            }
            
            if (questions.length === 0) {
                alert(mode === 'new' ? 'æ–°ã—ã„å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼' : 'å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼');
                return;
            }

            state.currentQuiz = {
                questions: questions.slice(0, state.settings.maxQuestions),
                currentIndex: 0,
                mode: mode
            };

            showScreen('quiz');
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (state.currentQuiz.currentIndex >= state.currentQuiz.questions.length) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                showScreen('mainMenu');
                return;
            }

            const question = state.currentQuiz.questions[state.currentQuiz.currentIndex];
            document.getElementById('japanese-question').textContent = question.japanese;
            document.getElementById('answer-textarea').value = '';
            document.getElementById('answer-textarea').focus();

            // Progress bar
            const progress = (state.currentQuiz.currentIndex / state.currentQuiz.questions.length) * 100;
            document.getElementById('quiz-progress').textContent = `å•é¡Œ ${state.currentQuiz.currentIndex + 1} / ${state.currentQuiz.questions.length}`;
            document.getElementById('quiz-progress-bar').style.width = `${progress}%`;

            // Reset conversation context for the new question
            state.conversationContext = null;

            if (state.settings.speechEnabled) {
                speak(question.japanese, 'ja-JP');
            }
        }

        async function submitAnswer() {
            const userAnswer = document.getElementById('answer-textarea').value.trim();
            if (!userAnswer) {
                alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const question = state.currentQuiz.questions[state.currentQuiz.currentIndex];
            showScreen('result');
            showResultLoading();

            try {
                const result = await rateAnswerByAI(question, userAnswer);
                await saveAnswer(question, userAnswer, result);
                showResultDisplay(question, userAnswer, result);
                // Sound effect
                playSound(result.isCorrect);

            } catch (error) {
                console.error("AIæ¡ç‚¹ã‚¨ãƒ©ãƒ¼:", error);
                alert(`æ¡ç‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                showScreen('quiz');
            }
        }

        // --- çµæœç”»é¢ã¨AIä¼šè©± ---
        function showResultLoading() {
            document.getElementById('result-loading').classList.remove('hidden');
            document.getElementById('result-display').classList.add('hidden');
            document.getElementById('english-tip').textContent = englishTips[Math.floor(Math.random() * englishTips.length)];
        }
        
        function showResultDisplay(question, userAnswer, result) {
            document.getElementById('result-loading').classList.add('hidden');
            document.getElementById('result-display').classList.remove('hidden');
            
            const header = document.getElementById('result-header');
            const title = document.getElementById('result-title');
            
            if (result.isCorrect) {
                header.className = 'text-center mb-6 p-4 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                title.textContent = 'æ­£è§£ï¼ğŸ‰';
            } else {
                header.className = 'text-center mb-6 p-4 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
                title.textContent = 'ã‚‚ã†å°‘ã—ï¼';
            }

            document.getElementById('result-japanese').textContent = question.japanese;
            document.getElementById('result-user-answer').textContent = userAnswer;
            document.getElementById('result-model-answer').textContent = question.english;
            document.getElementById('result-feedback').textContent = result.feedback;
            
            // AIä¼šè©±ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';
            
            state.conversationContext = {
                history: [
                    {
                        role: 'user',
                        parts: [{
                            text: `
ã‚ãªãŸã¯è¦ªåˆ‡ã§å„ªç§€ãªè‹±èªæ•™å¸«ã§ã™ã€‚ä»¥ä¸‹ã®è‹±ä½œæ–‡ã®æ¡ç‚¹çµæœã«ã¤ã„ã¦ã€ç”Ÿå¾’ã‹ã‚‰è³ªå•ã‚’å—ã‘ã¾ã™ã€‚
ç”Ÿå¾’ã®è³ªå•ã«ã€æ•™å¸«ã¨ã—ã¦ä¸å¯§ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ãç­”ãˆã¦ãã ã•ã„ã€‚

# æ¡ç‚¹æƒ…å ±
- æ—¥æœ¬èªåŸæ–‡: ${question.japanese}
- æ¨¡ç¯„è§£ç­”: ${question.english}
- ç”Ÿå¾’ã®å›ç­”: ${userAnswer}
- ã‚ãªãŸã®è©•ä¾¡: ${result.feedback}
`
                        }]
                    },
                    { role: 'model', parts: [{ text: 'ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã“ã®è‹±ä½œæ–‡ã«ã¤ã„ã¦ã€ã©ã®ã‚ˆã†ãªã“ã¨ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã­ã€‚' }] }
                ]
            };
            addMessageToChat('AI', 'ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã¤ã„ã¦ã€ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼ŸéŸ³å£°ã§ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚ã©ã†ãã€‚');
            
            // SRSãƒ¬ãƒ™ãƒ«è¡¨ç¤º
            const currentStat = state.questionStats.get(question.japanese);
            updateSrsLevelIndicator(currentStat ? currentStat.level : 0);
        }

        function updateSrsLevelIndicator(level) {
             const indicator = document.getElementById('srs-level-indicator');
             indicator.textContent = `ãƒ¬ãƒ™ãƒ« ${level}`;
             const percentage = (level / (REVIEW_INTERVALS.length - 1)) * 100;
             indicator.style.color = `hsl(${percentage * 1.2}, 80%, 45%)`;
        }

        async function handleChatSend() {
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            if (!userMessage || !state.conversationContext) return;
            
            input.value = '';
            addMessageToChat('You', userMessage);
            
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'æ€è€ƒä¸­...';

            try {
                // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§å¿œç­”ã‚’å–å¾—
                state.conversationContext.history.push({ role: 'user', parts: [{ text: userMessage }] });
                
                const stream = await geminiStream(state.conversationContext.history);
                
                let fullResponse = '';
                const aiMessageEl = addMessageToChat('AI', '');
                
                for await (const chunk of stream) {
                    const chunkText = chunk.text();
                    fullResponse += chunkText;
                    aiMessageEl.textContent = fullResponse;
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                state.conversationContext.history.push({ role: 'model', parts: [{ text: fullResponse }] });
                
                // é«˜å“è³ªéŸ³å£°ã§èª­ã¿ä¸Šã’
                try {
                    const audioUrl = await generateTts(fullResponse);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } catch(ttsError) {
                    console.error("Gemini TTS failed, falling back to browser speech.", ttsError);
                    speak(fullResponse, 'ja-JP'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }

            } catch (error) {
                console.error("AI chat error:", error);
                addMessageToChat('AI', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'é€ä¿¡';
            }
        }

        function addMessageToChat(sender, message) {
            const chatBox = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.classList.add('mb-2');
            
            const senderSpan = document.createElement('span');
            senderSpan.textContent = `${sender}: `;
            senderSpan.className = sender === 'AI' ? 'font-bold text-blue-600 dark:text-blue-400' : 'font-bold';
            
            const contentSpan = document.createElement('span');
            contentSpan.textContent = message;

            messageEl.appendChild(senderSpan);
            messageEl.appendChild(contentSpan);

            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;
            return contentSpan;
        }

        // --- APIé€£æº (Gemini & Web APIs) ---
        function loadApiKey() {
            state.apiKey = localStorage.getItem('geminiApiKey');
        }
        
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                state.apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                hideModal('apiKey');
                if (currentUser) { // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
                   onLogin();
                }
            } else {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        async function geminiApiCall(payload, stream = false) {
             if (!state.apiKey) {
                showModal('apiKey');
                throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            }
            
            const model = "gemini-2.5-flash-preview-05-20";
            const endpoint = stream ? "streamGenerateContent" : "generateContent";
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${endpoint}?key=${state.apiKey}`;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error:", errorData);
                throw new Error(errorData.error?.message || "APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
            return response;
        }

        async function rateAnswerByAI(question, userAnswer) {
            const prompt = `
ã‚ãªãŸã¯å„ªç§€ã§å¯›å®¹ãªè‹±èªæ•™å¸«ã§ã™ã€‚ç”Ÿå¾’ã®è‹±ä½œæ–‡ã‚’æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ã€‚
- å¥èª­ç‚¹(ã‚³ãƒ³ãƒ, ãƒ”ãƒªã‚ªãƒ‰ãªã©)ã€å¤§æ–‡å­—/å°æ–‡å­—ã®é•ã„ã¯ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
- æ–‡æ³•çš„ã«æ­£ã—ãã€æ„å‘³ãŒé€šã˜ã‚‹å ´åˆã¯ã€æ¨¡ç¯„è§£ç­”ã¨å¤šå°‘è¡¨ç¾ãŒç•°ãªã£ã¦ã„ã¦ã‚‚ã€Œæ­£è§£ã€ã¨ã—ã¦ãã ã•ã„ã€‚
- æ¡ç‚¹çµæœã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
- JSONã«ã¯ isCorrect (boolean), feedback (string) ã®2ã¤ã®ã‚­ãƒ¼ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- feedbackã¯ã€ç”Ÿå¾’ã‚’åŠ±ã¾ã™ã‚ˆã†ãªãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒˆãƒ¼ãƒ³ã§ã€å…·ä½“çš„ã«ã©ã“ãŒè‰¯ã‹ã£ãŸã‹ã€ã©ã“ã‚’æ”¹å–„ã§ãã‚‹ã‹ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

# æ¡ç‚¹å¯¾è±¡
- æ—¥æœ¬èªåŸæ–‡: ${question.japanese}
- æ¨¡ç¯„è§£ç­”: ${question.english}
- ç”Ÿå¾’ã®å›ç­”: ${userAnswer}
`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                 generationConfig: {
                    responseMimeType: "application/json",
                 }
            };

            const response = await geminiApiCall(payload);
            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            return JSON.parse(text);
        }
        
        async function geminiStream(history) {
            const payload = { contents: history };
            const response = await geminiApiCall(payload, true);
            const data = await response.json();
            // This is a simplified stream handling for demo purposes.
            // A more robust implementation would handle the stream chunks directly.
            return data.map(d => ({ text: () => d.candidates[0].content.parts[0].text }));
        }

        async function generateTts(text) {
             if (!state.apiKey) throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${state.apiKey}`;
            const payload = {
                model: "gemini-2.5-flash-preview-tts",
                contents: [{ parts: [{ text: text }] }],
                generationConfig: { responseModalities: ["AUDIO"] }
            };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('TTS API request failed');
            const result = await response.json();
            const audioData = result.candidates[0].content.parts[0].inlineData.data;
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, 24000); // Gemini TTS sample rate is 24kHz
            return URL.createObjectURL(wavBlob);
        }
        
        // --- ãƒ–ãƒ©ã‚¦ã‚¶API: Speech, Audio, etc. ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        function initSpeechRecognition(lang, onResult, onEnd) {
            if (!SpeechRecognition) {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return null;
            }
            const rec = new SpeechRecognition();
            rec.lang = lang;
            rec.interimResults = true;
            rec.continuous = false;

            rec.onresult = event => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                onResult(finalTranscript, interimTranscript);
            };
            
            rec.onend = onEnd;
            rec.onerror = event => {
                console.error("SpeechRecognition error", event.error);
                onEnd();
            };
            return rec;
        }

        function toggleMic() {
            if (state.isMicRecording) {
                recognition.stop();
            } else {
                 recognition = initSpeechRecognition(
                    'en-US',
                    (final, interim) => {
                        document.getElementById('answer-textarea').value = final + interim;
                    },
                    () => {
                        state.isMicRecording = false;
                        updateMicButtonUI();
                    }
                );
                if(recognition) {
                    recognition.start();
                    state.isMicRecording = true;
                    updateMicButtonUI();
                }
            }
        }
        
        function updateMicButtonUI() {
            const micIcon = document.getElementById('mic-icon');
            const recordingIcon = document.getElementById('mic-recording-icon');
            if(state.isMicRecording) {
                micIcon.classList.add('hidden');
                recordingIcon.classList.remove('hidden');
            } else {
                micIcon.classList.remove('hidden');
                recordingIcon.classList.add('hidden');
            }
        }

        function toggleChatMic() {
            if (state.isChatMicRecording) {
                recognition.stop();
            } else {
                 recognition = initSpeechRecognition(
                    'ja-JP',
                    (final, interim) => {
                        document.getElementById('chat-input').value = final + interim;
                    },
                    () => {
                        state.isChatMicRecording = false;
                        updateChatMicButtonUI();
                    }
                );
                if(recognition) {
                    recognition.start();
                    state.isChatMicRecording = true;
                    updateChatMicButtonUI();
                }
            }
        }
        
        function updateChatMicButtonUI() {
            const micIcon = document.getElementById('chat-mic-icon');
            const recordingIcon = document.getElementById('chat-mic-recording-icon');
             if(state.isChatMicRecording) {
                micIcon.classList.add('hidden');
                recordingIcon.classList.remove('hidden');
            } else {
                micIcon.classList.remove('hidden');
                recordingIcon.classList.add('hidden');
            }
        }
        
        function speak(text, lang) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        function playSound(isCorrect) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);

            if (isCorrect) {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.1); // C6
            } else {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
            }

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }
        
        // --- è¨­å®šç®¡ç† ---
        function loadSettings() {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('appSettings'));
                if (savedSettings) {
                    state.settings = { ...DEFAULT_SETTINGS, ...savedSettings };
                }
            } catch(e) { console.error("Failed to load settings", e); }
            updateSettingsUI();
        }

        function saveSettings() {
            state.settings.maxQuestions = parseInt(document.getElementById('max-questions').value, 10);
            state.settings.questionOrder = document.getElementById('question-order').value;
            state.settings.speechEnabled = document.getElementById('speech-toggle').checked;
            localStorage.setItem('appSettings', JSON.stringify(state.settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function updateSettingsUI() {
            document.getElementById('max-questions').value = state.settings.maxQuestions;
            document.getElementById('question-order').value = state.settings.questionOrder;
            document.getElementById('speech-toggle').checked = state.settings.speechEnabled;
        }

        // --- ã‚«ã‚¹ã‚¿ãƒ å•é¡Œé›† ---
        function handleFileUpload() {
            const titleInput = document.getElementById('custom-set-title');
            const fileInput = document.getElementById('csv-file-input');
            const statusEl = document.getElementById('upload-status');
            
            const title = titleInput.value.trim();
            const file = fileInput.files[0];

            if (!title || !file) {
                statusEl.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                statusEl.className = 'mt-2 h-5 text-red-500';
                return;
            }
            if (!file.name.endsWith('.csv')) {
                statusEl.textContent = 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                statusEl.className = 'mt-2 h-5 text-red-500';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r\n|\n/);
                    const questions = [];
                    for(let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = line.split(',');
                        if (parts.length < 2 || !parts[0].trim() || !parts[1].trim()) {
                            throw new Error(`ã‚¨ãƒ©ãƒ¼: ${i+1}è¡Œç›®ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                        const japanese = parts.shift().trim();
                        const english = parts.join(',').trim();
                        questions.push({ japanese, english });
                    }
                    if (questions.length === 0) {
                        throw new Error("æœ‰åŠ¹ãªå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }

                    // Firestoreã«ä¿å­˜
                    const setsCol = collection(db, `users/${currentUser.uid}/problemSets`);
                    await setDoc(doc(setsCol), {
                        title,
                        questions,
                        createdAt: serverTimestamp(),
                    });

                    statusEl.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸï¼';
                    statusEl.className = 'mt-2 h-5 text-green-600 dark:text-green-400';
                    titleInput.value = '';
                    fileInput.value = '';

                } catch (error) {
                    console.error("CSV Parse/Upload Error:", error);
                    statusEl.textContent = error.message;
                    statusEl.className = 'mt-2 h-5 text-red-500';
                }
            };
            reader.readAsText(file);
        }

        function updateCustomSetList() {
            const listEl = document.getElementById('custom-set-list');
            if (!listEl || !currentUser) return;

            if (state.customSets.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">ã¾ã å•é¡Œé›†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            listEl.innerHTML = state.customSets.map(set => {
                const total = set.questions?.length || 0;
                const learned = set.questions?.filter(q => state.questionStats.has(q.japanese)).length || 0;

                return `
                <div class="p-4 border rounded-lg flex justify-between items-center bg-gray-50 dark:bg-gray-700/50">
                    <div>
                        <h4 class="font-bold text-lg">${set.title}</h4>
                        <p class="text-sm text-gray-500">å…¨${total}å•ä¸­ ${learned}å•å­¦ç¿’æ¸ˆã¿</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-set-id="${set.id}" class="btn btn-primary start-custom-quiz-btn">å­¦ç¿’ã™ã‚‹</button>
                        <button data-set-id="${set.id}" class="btn btn-danger delete-custom-set-btn">å‰Šé™¤</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function deleteCustomSet(setId) {
            if (confirm("æœ¬å½“ã«ã“ã®å•é¡Œé›†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
                const setRef = doc(db, `users/${currentUser.uid}/problemSets`, setId);
                await deleteDoc(setRef);
            }
        }


        // --- å±¥æ­´ç”»é¢ ---
        function updateHistoryScreen() {
            const tbody = document.getElementById('history-table-body');
            const filter = document.getElementById('history-filter').value;
            if (!tbody || !currentUser) return;
            
            const filteredHistory = state.allHistory
                .filter(item => {
                    if (filter === 'all') return true;
                    return filter === 'correct' ? item.isCorrect : !item.isCorrect;
                })
                .sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate());
            
            if (filteredHistory.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
                 return;
            }

            tbody.innerHTML = filteredHistory.map(item => `
                <tr class="${item.isCorrect ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.timestamp.toDate().toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm">${item.japanese}</td>
                    <td class="px-6 py-4 text-sm">${item.userAnswer}</td>
                    <td class="px-6 py-4 text-sm font-medium ${item.isCorrect ? 'text-green-600' : 'text-red-600'}">${item.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£'}</td>
                </tr>
            `).join('');
        }
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        function initEventListeners() {
            // Auth
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);

            // Modals
            document.getElementById('save-api-key-btn').addEventListener('click', saveApiKey);
            document.getElementById('api-key-input').addEventListener('keypress', (e) => e.key === 'Enter' && saveApiKey());
            document.getElementById('close-settings-btn').addEventListener('click', () => {
                saveSettings();
                hideModal('settings');
            });
            document.getElementById('reset-api-key-btn').addEventListener('click', () => {
                if(confirm('APIã‚­ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('geminiApiKey');
                    state.apiKey = null;
                    hideModal('settings');
                    onLogout();
                    showModal('apiKey');
                }
            });

            // Main Menu
            document.getElementById('review-btn').addEventListener('click', () => startQuiz('review'));
            document.getElementById('new-question-btn').addEventListener('click', () => startQuiz('new'));
            document.getElementById('custom-sets-btn').addEventListener('click', () => {
                updateCustomSetList();
                showScreen('customSets');
            });
            document.getElementById('history-btn').addEventListener('click', () => {
                updateHistoryScreen();
                showScreen('history');
            });

            // Quiz Screen
            document.getElementById('submit-answer-btn').addEventListener('click', submitAnswer);
            document.getElementById('answer-textarea').addEventListener('keypress', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitAnswer();
                }
            });
            document.getElementById('quit-quiz-btn').addEventListener('click', () => {
                if (confirm('ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ')) {
                    showScreen('mainMenu');
                }
            });
            document.getElementById('mic-btn').addEventListener('click', toggleMic);

            // Result Screen
            document.getElementById('next-question-btn-result').addEventListener('click', () => {
                state.currentQuiz.currentIndex++;
                showScreen('quiz');
                loadNextQuestion();
            });
            document.querySelectorAll('.srs-level-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const levelChange = parseInt(e.currentTarget.dataset.levelChange, 10);
                    const question = state.currentQuiz.questions[state.currentQuiz.currentIndex];
                    updateSrsLevel(question, levelChange);
                });
            });
            document.getElementById('chat-send-btn').addEventListener('click', handleChatSend);
            document.getElementById('chat-input').addEventListener('keypress', (e) => e.key === 'Enter' && handleChatSend());
            document.getElementById('chat-mic-btn').addEventListener('click', toggleChatMic);

            // History Screen
            document.getElementById('back-to-menu-from-history').addEventListener('click', () => showScreen('mainMenu'));
            document.getElementById('history-filter').addEventListener('change', updateHistoryScreen);

            // Custom Sets Screen
            document.getElementById('back-to-menu-from-custom-sets').addEventListener('click', () => showScreen('mainMenu'));
            document.getElementById('upload-csv-btn').addEventListener('click', handleFileUpload);
            document.getElementById('custom-set-list').addEventListener('click', e => {
                if (e.target.classList.contains('start-custom-quiz-btn')) {
                    startQuiz('custom', e.target.dataset.setId);
                }
                if (e.target.classList.contains('delete-custom-set-btn')) {
                    deleteCustomSet(e.target.dataset.setId);
                }
            });
        }
        
        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const pcmLength = pcmData.length * 2; // 16-bit
            const totalLength = pcmLength + 36;
            
            // RIFF
            writeString(view, 0, 'RIFF');
            view.setUint32(4, totalLength, true);
            writeString(view, 8, 'WAVE');
            // fmt
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size for PCM
            view.setUint16(20, 1, true); // AudioFormat for PCM
            view.setUint16(22, 1, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate
            view.setUint16(32, 2, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample
            // data
            writeString(view, 36, 'data');
            view.setUint32(40, pcmLength, true);

            const wav = new Blob([view, pcmData], { type: 'audio/wav' });
            return wav;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

    </script>
</body>
</html>

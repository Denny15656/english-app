<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI英作文練習アプリ - 間隔反復システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .review-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-app-wrapper">
        <div class="container mx-auto p-4 md:p-8 max-w-3xl">
            <header class="text-center mb-8 relative">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI 英作文練習アプリ</h1>
                <p class="text-gray-600 mt-2">間隔反復システムで効率的に学習しよう</p>
                <div id="streak-display" class="absolute top-0 left-0 flex items-center bg-orange-100 text-orange-600 font-bold px-3 py-1 rounded-full text-lg hidden">
                    🔥 <span id="streak-count" class="ml-1">0</span>
                </div>
                <div class="absolute top-0 right-0 flex items-center space-x-2">
                    <div id="user-id-display" class="text-xs text-gray-400 mr-2"></div>
                    <div class="tooltip">
                        <button id="auto-read-aloud-toggle" class="p-2 rounded-full hover:bg-gray-200 transition text-gray-500 hover:text-gray-800"></button>
                        <span class="tooltiptext">自動読み上げ</span>
                    </div>
                    <div class="tooltip">
                        <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition text-gray-500 hover:text-gray-800">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <span class="tooltiptext">設定</span>
                    </div>
                </div>
            </header>
            
            <div id="settings-modal" class="modal-overlay hidden"></div>
            <section id="mode-selection" class="bg-white p-6 rounded-2xl shadow-lg mb-8"></section>
            <main id="app-container" class="bg-white p-6 rounded-2xl shadow-lg mb-8 hidden"></main>
            <section id="history-section" class="bg-white p-6 rounded-2xl shadow-lg"></section>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const ICONS = {
            readAloudOn: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`,
            readAloudOff: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.95 12.95a1 1 0 01-1.414 1.414L10 11.414l-1.536 1.536a1 1 0 11-1.414-1.414L8.586 10 7.05 8.464a1 1 0 011.414-1.414L10 8.586l1.536-1.536a1 1 0 111.414 1.414L11.414 10l1.536 1.536z" clip-rule="evenodd" /></svg>`
        };
        const REVIEW_INTERVALS = [1, 3, 7, 14, 30, 60, 120, 240]; 
        const MASTERED_LEVEL = 5; 
        const defaultSentences = [
            { ja: "このアプリは英語を学ぶのにとても役立ちます。", en: "This app is very helpful for learning English." },
            { ja: "昨日は友達と映画を見に行きました。", en: "I went to see a movie with my friend yesterday." },
            { ja: "もし時間があれば、この本を読むべきです。", en: "If you have time, you should read this book." },
        ];

        let dom = {};
        let app, auth, db;
        let userId = null;
        let isAutoReadAloud = true;
        let settings = { maxQuestionsPerSession: 20, customQuestionOrder: 'random' };
        let currentQuestionIndex = 0;
        let allTimeHistory = [];
        let questionStats = new Map();
        let currentFilter = 'all';
        let customSentences = [];
        let allKnownSentences = new Map();
        let activeSentences = [];
        let recognition;
        let isRecognizing = false;
        let audioCtx;

        function populateUI() {
            document.getElementById('settings-modal').innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-6">設定</h3><div class="space-y-6"><div><label for="max-questions-input" class="block text-sm font-medium text-gray-700 mb-1">1セッションの最大問題数</label><input type="number" id="max-questions-input" min="5" max="100" class="w-full p-2 border border-gray-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">一度に学習する問題の数を設定します。(5〜100)</p></div><div><label class="block text-sm font-medium text-gray-700 mb-2">カスタム問題の出題順</label><div class="flex space-x-4"><label class="inline-flex items-center"><input type="radio" name="question-order" value="random" class="form-radio text-blue-600"> <span class="ml-2">ランダム</span></label><label class="inline-flex items-center"><input type="radio" name="question-order" value="in-order" class="form-radio text-blue-600"> <span class="ml-2">ファイル順</span></label></div></div></div><div class="mt-8 flex justify-end space-x-3"><button id="settings-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">キャンセル</button><button id="settings-save-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">保存</button></div></div>`;
            document.getElementById('mode-selection').innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center">学習モードを選択</h2><div class="grid md:grid-cols-3 gap-6"><div class="border p-4 rounded-lg flex flex-col"><h3 class="font-semibold text-lg mb-2 relative">📅 今日の復習<span id="review-count-badge" class="review-count hidden">0</span></h3><p class="text-sm text-gray-600 mb-3 flex-grow">忘却曲線に基づき、復習時期が来た問題を解きます。</p><button id="start-review-quiz-btn" class="w-full mt-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400" disabled>復習を開始</button></div><div class="border p-4 rounded-lg flex flex-col"><h3 class="font-semibold text-lg mb-2">🚀 新しい問題を学ぶ</h3><p class="text-sm text-gray-600 mb-3 flex-grow">まだ学習したことのない、デフォルト問題に挑戦します。</p><button id="start-default-quiz-btn" class="w-full mt-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">学習を開始</button></div><div class="border p-4 rounded-lg flex flex-col"><h3 class="font-semibold text-lg mb-2">📚 カスタム問題で学ぶ</h3><p class="text-sm text-gray-600 mb-3 flex-grow">CSVから新しい問題を読み込んで挑戦します。</p><input type="file" id="csv-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2" accept=".csv"><p id="upload-status" class="text-xs text-green-600 h-4"></p><button id="start-custom-quiz-btn" class="w-full mt-auto bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 disabled:bg-gray-400" disabled>カスタム学習を開始</button></div></div>`;
            document.getElementById('app-container').innerHTML = `<div id="loading-screen" class="hidden justify-center items-center py-10"><div class="loader"></div><p class="mt-4">AIが採点中です...</p></div><div id="quiz-section"><div class="flex justify-between items-center mb-4"><p id="progress-counter" class="text-sm font-medium"></p></div><div class="bg-gray-50 p-4 rounded-lg mb-4"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-600 mb-1">日本語</p><p id="japanese-sentence" class="text-lg font-semibold"></p></div><button id="read-aloud-btn" class="p-2 rounded-full hover:bg-gray-200" title="読み上げ"></button></div></div><div id="model-answer-container" class="hidden bg-blue-50 p-4 rounded-lg mb-4"><p class="text-sm text-blue-600 mb-1">模範解答</p><p id="model-answer" class="text-md font-medium text-blue-800"></p></div><div><label for="english-input" class="block text-sm font-medium">あなたの回答</label><div class="relative"><textarea id="english-input" rows="4" class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:ring-blue-500"></textarea><button id="mic-btn" class="absolute top-1/2 right-3 -translate-y-1/2 p-2 text-gray-500" title="音声入力"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-5.445-5.921V4a5 5 0 00-10 0v.08A6.001 6.001 0 019 14.93V17a1 1 0 102 0v-2.07z" clip-rule="evenodd"></path></svg></button></div><p id="mic-status" class="text-xs h-4 mt-1"></p></div><button id="submit-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">採点する</button><div id="result-area" class="mt-6 hidden"></div><div id="manual-srs-area" class="mt-4 hidden"></div><button id="next-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-lg hidden hover:bg-green-700">次の問題へ</button></div><div id="finish-screen" class="hidden text-center py-10"><h2 id="finish-title" class="text-2xl font-bold text-green-600"></h2><p id="finish-message" class="mt-2"></p><div class="flex justify-center mt-6"><button id="back-to-mode-select-btn" class="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700">モード選択に戻る</button></div></div>`;
            document.getElementById('history-section').innerHTML = `<h2 class="text-2xl font-bold mb-4">学習統計</h2><div id="stats-area" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"><div><p class="text-2xl font-bold text-blue-600" id="stat-learning">0</p><p class="text-sm text-gray-500">学習中</p></div><div><p class="text-2xl font-bold text-green-600" id="stat-mastered">0</p><p class="text-sm text-gray-500">習得済み</p></div><div><p class="text-2xl font-bold text-yellow-600" id="stat-due">0</p><p class="text-sm text-gray-500">今日復習</p></div><div><p class="text-2xl font-bold text-gray-600" id="stat-total">0</p><p class="text-sm text-gray-500">全問題数</p></div></div><h3 class="text-xl font-bold mb-4">全回答履歴</h3><div id="history-filters" class="flex flex-wrap gap-2 mb-4"><button data-filter="all" class="history-filter-btn bg-blue-200 text-blue-800 py-1 px-3 rounded-full text-sm">すべて</button><button data-filter="correct" class="history-filter-btn bg-gray-200 text-gray-800 py-1 px-3 rounded-full text-sm">正解のみ</button><button data-filter="incorrect" class="history-filter-btn bg-gray-200 text-gray-800 py-1 px-3 rounded-full text-sm">不正解のみ</button></div><ul id="history-list" class="space-y-4"></ul>`;
        }
        
        function assignDomElements() {
            dom = {
                mainAppWrapper: document.getElementById('main-app-wrapper'),
                userIdDisplay: document.getElementById('user-id-display'),
                streakDisplay: document.getElementById('streak-display'),
                streakCount: document.getElementById('streak-count'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                maxQuestionsInput: document.getElementById('max-questions-input'),
                settingsSaveBtn: document.getElementById('settings-save-btn'),
                settingsCancelBtn: document.getElementById('settings-cancel-btn'),
                modeSelection: document.getElementById('mode-selection'),
                appContainer: document.getElementById('app-container'),
                startDefaultQuizBtn: document.getElementById('start-default-quiz-btn'),
                startCustomQuizBtn: document.getElementById('start-custom-quiz-btn'),
                startReviewQuizBtn: document.getElementById('start-review-quiz-btn'),
                reviewCountBadge: document.getElementById('review-count-badge'),
                autoReadAloudToggle: document.getElementById('auto-read-aloud-toggle'),
                csvUpload: document.getElementById('csv-upload'),
                uploadStatus: document.getElementById('upload-status'),
                loadingScreen: document.getElementById('loading-screen'),
                quizSection: document.getElementById('quiz-section'),
                finishScreen: document.getElementById('finish-screen'),
                finishTitle: document.getElementById('finish-title'),
                finishMessage: document.getElementById('finish-message'),
                japaneseSentence: document.getElementById('japanese-sentence'),
                readAloudBtn: document.getElementById('read-aloud-btn'),
                modelAnswerContainer: document.getElementById('model-answer-container'),
                modelAnswer: document.getElementById('model-answer'),
                englishInput: document.getElementById('english-input'),
                micBtn: document.getElementById('mic-btn'),
                micStatus: document.getElementById('mic-status'),
                submitBtn: document.getElementById('submit-btn'),
                resultArea: document.getElementById('result-area'),
                manualSrsArea: document.getElementById('manual-srs-area'),
                nextBtn: document.getElementById('next-btn'),
                backToModeSelectBtn: document.getElementById('back-to-mode-select-btn'),
                progressCounter: document.getElementById('progress-counter'),
                historyList: document.getElementById('history-list'),
                historyFilters: document.getElementById('history-filters'),
                stats: {
                    learning: document.getElementById('stat-learning'),
                    mastered: document.getElementById('stat-mastered'),
                    due: document.getElementById('stat-due'),
                    total: document.getElementById('stat-total'),
                }
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            populateUI();
            assignDomElements();
            
            loadSettings();
            initializeFirebase();
            initializeAudio();
            initializeSpeechRecognition();
            
            setupEventListeners();
        });

        function setupEventListeners() {
            dom.settingsBtn.addEventListener('click', () => dom.settingsModal.classList.remove('hidden'));
            dom.settingsCancelBtn.addEventListener('click', () => dom.settingsModal.classList.add('hidden'));
            dom.settingsSaveBtn.addEventListener('click', saveSettings);
            dom.startDefaultQuizBtn.addEventListener('click', () => startQuiz(defaultSentences.filter(q => !questionStats.has(q.ja)), 'default'));
            dom.startCustomQuizBtn.addEventListener('click', () => startQuiz(customSentences, 'custom'));
            dom.startReviewQuizBtn.addEventListener('click', () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const dueSentences = Array.from(questionStats.values())
                    .filter(stat => stat.nextReviewDate?.toDate() <= today)
                    .map(stat => allKnownSentences.get(stat.ja))
                    .filter(Boolean);
                startQuiz(dueSentences, 'review');
            });
            dom.csvUpload.addEventListener('change', handleFileUpload);
            dom.autoReadAloudToggle.addEventListener('click', () => { 
                isAutoReadAloud = !isAutoReadAloud;
                dom.autoReadAloudToggle.innerHTML = isAutoReadAloud ? ICONS.readAloudOn : ICONS.readAloudOff;
            });
            dom.appContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.closest('#submit-btn')) handleSubmit();
                else if (target.closest('#next-btn')) { currentQuestionIndex++; showQuestion(); }
                else if (target.closest('#back-to-mode-select-btn')) { dom.appContainer.classList.add('hidden'); dom.modeSelection.classList.remove('hidden'); }
                else if (target.closest('#mic-btn')) { if (recognition) isRecognizing ? recognition.stop() : recognition.start(); }
                else if (target.closest('#read-aloud-btn')) handleReadAloud();
                else if (target.matches('.srs-adj-btn')) {
                    target.closest('div').querySelectorAll('button').forEach(b => b.disabled = true);
                    const adjustment = parseInt(target.dataset.adj, 10);
                    const question = activeSentences[currentQuestionIndex];
                    await updateQuestionSRS(question, null, adjustment);
                    document.getElementById('srs-adj-feedback').textContent = '復習レベルを更新しました！';
                }
            });
            document.getElementById('history-section').addEventListener('click', e => { 
                 if (e.target.matches('.history-filter-btn')) {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('.history-filter-btn').forEach(b => { 
                        b.classList.remove('bg-blue-200', 'text-blue-800');
                        b.classList.add('bg-gray-200', 'text-gray-800'); 
                    });
                    e.target.classList.add('bg-blue-200', 'text-blue-800');
                    e.target.classList.remove('bg-gray-200', 'text-gray-800');
                    renderHistory();
                }
            });
        }

        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            if (!firebaseConfig.apiKey) { console.error("Firebase config is missing."); return; }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    dom.userIdDisplay.textContent = `ID: ${userId.substring(0, 8)}...`;
                    loadAllUserData();
                }
            });

            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (auth.currentUser) {
                    // Already signed in
                    userId = auth.currentUser.uid;
                    dom.userIdDisplay.textContent = `ID: ${userId.substring(0, 8)}...`;
                    loadAllUserData();
                } else if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-500">認証に失敗しました。アプリをロードできません。</div>`;
            }
        }

        // --- All other functions (unchanged) ---
        function initializeAudio() { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { console.warn("Web Audio API is not supported."); } }
        function playSound(type) { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(900, audioCtx.currentTime + 0.1); } else { o.type = 'square'; o.frequency.setValueAtTime(220, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(180, audioCtx.currentTime + 0.15); } g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.2); }
        function initializeSpeechRecognition() { window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!('SpeechRecognition' in window)) { if(dom.micBtn) dom.micBtn.style.display = 'none'; if(dom.micStatus) dom.micStatus.textContent = "音声入力に非対応です。"; return; } recognition = new SpeechRecognition(); recognition.continuous = false; recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.onstart = () => { isRecognizing = true; dom.micStatus.textContent = '音声入力中...'; dom.micBtn.classList.add('text-red-500'); }; recognition.onresult = (event) => { let transcript = event.results[0][0].transcript; if (dom.englishInput.value.trim() === '') { transcript = transcript.charAt(0).toUpperCase() + transcript.slice(1); dom.englishInput.value = transcript; } else { dom.englishInput.value += ' ' + transcript; } }; recognition.onerror = (event) => { let message = '音声認識エラー'; if (event.error === 'no-speech') message = '音声が認識できませんでした。'; else if (event.error === 'not-allowed') message = 'マイクの使用が許可されていません。'; dom.micStatus.textContent = message; }; recognition.onend = () => { isRecognizing = false; dom.micStatus.textContent = ''; dom.micBtn.classList.remove('text-red-500'); }; }
        function handleReadAloud() { if ('speechSynthesis' in window && dom.japaneseSentence) { const utterance = new SpeechSynthesisUtterance(dom.japaneseSentence.textContent); utterance.lang = 'ja-JP'; window.speechSynthesis.speak(utterance); } }
        async function getAIEvaluation(japanese, modelAnswer, userAnswer) { const prompt = `あなたは優秀な英語の先生です。以下の日本語の文章を英訳する課題において、ユーザーが提出した英文を評価してください。\n# 指示\n- ユーザーの英文が、日本語の文章の意味を正確に反映しているか評価してください。\n- 文法的に自然で正しい英語かも評価してください。\n- 模範解答と完全に一致している必要はありません。同義語や別の構文が使われていても、意味と文法が正しければ「正解」としてください。\n- 特に、文頭の大文字・小文字の違いは採点に影響させないでください。多少のタイポや大文字・小文字の間違いには寛容に評価してください。\n- 評価結果と、なぜそのように評価したかの短いフィードバックをJSON形式で返してください。フィードバックは簡潔で、学習の助けになるようにしてください。\n# 情報\n- 日本語原文: ${japanese}\n- 模範解答: ${modelAnswer}\n- ユーザーの解答: ${userAnswer}`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { isCorrect: { type: "BOOLEAN" }, feedback: { type: "STRING" } }, required: ["isCorrect", "feedback"] } } }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API request failed with status ${response.status}`); const result = await response.json(); const part = result?.candidates?.[0]?.content?.parts?.[0]; if (part && part.text) return JSON.parse(part.text); throw new Error("Unexpected API response structure"); } catch (error) { console.error("Error calling Gemini API:", error); return { isCorrect: false, feedback: "AIによる採点ができませんでした。" }; } }
        function getCollectionRef(collectionName) { if (!userId) throw new Error("User not authenticated"); const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`); }
        async function loadAllUserData() { if (!userId) return; const profileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile/main`); const profileSnap = await getDoc(profileDocRef); updateStreak(profileSnap.exists() ? profileSnap.data() : null); onSnapshot(query(getCollectionRef('questionStats')), snapshot => { const newStats = new Map(); snapshot.docs.forEach(docSnap => { const data = docSnap.data(); if(!allKnownSentences.has(data.ja)) allKnownSentences.set(data.ja, {ja: data.ja, en: data.en}); newStats.set(data.ja, { id: docSnap.id, ...data }); }); questionStats = newStats; updateStatsUI(); }); onSnapshot(query(getCollectionRef('history')), snapshot => { allTimeHistory = snapshot.docs.map(docSnap => ({id: docSnap.id, ...docSnap.data()})); renderHistory(); }); }
        async function updateQuestionSRS(question, isCorrect, adjustment = null) { const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const stats = questionStats.get(question.ja) || { ja: question.ja, en: question.en, level: 0, createdAt: Timestamp.fromDate(today) }; if (adjustment !== null) { stats.level = Math.max(0, (stats.level || 0) + adjustment); } else if (isCorrect) { stats.level = (stats.level || 0) + 1; } else { stats.level = 0; } const intervalDays = REVIEW_INTERVALS[Math.min(stats.level, REVIEW_INTERVALS.length - 1)]; const nextReviewDate = new Date(today); nextReviewDate.setDate(today.getDate() + intervalDays); stats.nextReviewDate = Timestamp.fromDate(nextReviewDate); stats.lastAttempted = Timestamp.fromDate(now); const docRef = stats.id ? doc(getCollectionRef('questionStats'), stats.id) : doc(getCollectionRef('questionStats')); await setDoc(docRef, stats, { merge: true }); }
        async function updateStreak(profileData) { const now = new Date(); const todayStr = now.toISOString().split('T')[0]; const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0]; let streak = 1; if (profileData && profileData.lastLoginDate) { const lastLoginStr = profileData.lastLoginDate; if (lastLoginStr === todayStr) streak = profileData.streakCount || 1; else if (lastLoginStr === yesterdayStr) streak = (profileData.streakCount || 0) + 1; } dom.streakDisplay.classList.remove('hidden'); dom.streakCount.textContent = streak; const profileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile/main`); await setDoc(profileDocRef, { streakCount: streak, lastLoginDate: todayStr }, { merge: true }); }
        function loadSettings() { const savedSettings = localStorage.getItem('engApp.settings'); if (savedSettings) settings = JSON.parse(savedSettings); dom.maxQuestionsInput.value = settings.maxQuestionsPerSession; document.querySelector(`input[name="question-order"][value="${settings.customQuestionOrder}"]`).checked = true; }
        function saveSettings() { const newMax = parseInt(dom.maxQuestionsInput.value, 10); if (newMax < 5 || newMax > 100) { alert('5から100の数値を入力'); return; } settings.maxQuestionsPerSession = newMax; settings.customQuestionOrder = document.querySelector('input[name="question-order"]:checked').value; localStorage.setItem('engApp.settings', JSON.stringify(settings)); dom.settingsModal.classList.add('hidden'); }
        function updateStatsUI() { const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); let learning = 0, mastered = 0, due = 0; questionStats.forEach(stat => { if(stat.level >= MASTERED_LEVEL) mastered++; else learning++; if (stat.nextReviewDate?.toDate() <= today) due++; }); dom.stats.learning.textContent = learning; dom.stats.mastered.textContent = mastered; dom.stats.due.textContent = due; dom.stats.total.textContent = allKnownSentences.size; dom.reviewCountBadge.textContent = due; dom.reviewCountBadge.classList.toggle('hidden', due === 0); dom.startReviewQuizBtn.disabled = due === 0; }
        function startQuiz(sentences, mode) { currentQuestionIndex = 0; let finalSentences = sentences; if (mode === 'custom') { if (settings.customQuestionOrder === 'random') finalSentences = [...sentences].sort(() => 0.5 - Math.random()); } activeSentences = finalSentences.slice(0, settings.maxQuestionsPerSession); if(activeSentences.length === 0){ dom.modeSelection.classList.add('hidden'); dom.appContainer.classList.remove('hidden'); dom.quizSection.classList.add('hidden'); dom.finishScreen.classList.remove('hidden'); dom.finishTitle.textContent = "問題がありません"; dom.finishMessage.textContent = "このモードで学習する問題は現在ありません。"; return; } dom.modeSelection.classList.add('hidden'); dom.appContainer.classList.remove('hidden'); showQuestion(); }
        function showQuestion() { if (currentQuestionIndex >= activeSentences.length) { dom.quizSection.classList.add('hidden'); dom.finishScreen.classList.remove('hidden'); dom.finishTitle.textContent = "セッション完了！"; dom.finishMessage.textContent = "お疲れ様でした！"; return; } dom.quizSection.classList.remove('hidden'); dom.finishScreen.classList.add('hidden'); dom.loadingScreen.classList.add('hidden'); const q = activeSentences[currentQuestionIndex]; dom.japaneseSentence.textContent = q.ja; dom.englishInput.value = ""; dom.englishInput.disabled = false; dom.submitBtn.disabled = false; dom.submitBtn.classList.remove('hidden'); dom.nextBtn.classList.add('hidden'); dom.resultArea.classList.add('hidden'); dom.modelAnswerContainer.classList.add('hidden'); dom.manualSrsArea.classList.add('hidden'); dom.progressCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${activeSentences.length}`; if (isAutoReadAloud) setTimeout(handleReadAloud, 100); }
        function renderResult({ isCorrect, feedback }) { const rC = isCorrect ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'; const rT = isCorrect ? '正解！' : 'もう一歩！'; dom.resultArea.innerHTML = `<div class="p-4 rounded-lg border ${rC}"><h3 class="font-bold text-lg mb-2">${rT}</h3><p>${feedback}</p></div>`; dom.resultArea.classList.remove('hidden'); dom.modelAnswerContainer.classList.remove('hidden'); dom.modelAnswer.textContent = activeSentences[currentQuestionIndex].en; }
        function renderManualSrsControls() { const question = activeSentences[currentQuestionIndex]; const stats = questionStats.get(question.ja) || { level: 0 }; dom.manualSrsArea.innerHTML = `<p class="text-sm text-center text-gray-600 mb-2">現在の復習レベル: ${stats.level}</p><div class="flex justify-center gap-4"><button data-adj="-1" class="srs-adj-btn bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg hover:bg-yellow-200">まだ苦手...</button><button data-adj="1" class="srs-adj-btn bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">簡単だった!</button></div><p id="srs-adj-feedback" class="text-center text-sm text-blue-600 h-4 mt-2"></p>`; dom.manualSrsArea.classList.remove('hidden'); }
        function renderHistory() { if(!dom.historyList) return; const sortedHistory = [...allTimeHistory].sort((a,b) => (b.timestamp?.seconds ?? 0) - (a.timestamp?.seconds ?? 0)); if (sortedHistory.length === 0) { dom.historyList.innerHTML = '<li class="text-center text-gray-500">まだ学習履歴がありません。</li>'; return; } const fH = sortedHistory.filter(i => currentFilter === 'all' || (currentFilter === 'correct' && i.isCorrect) || (currentFilter === 'incorrect' && !i.isCorrect)); if (fH.length === 0) { dom.historyList.innerHTML = `<li class="text-center text-gray-500">この条件に合う履歴はありません。</li>`; return; } dom.historyList.innerHTML = fH.map(i => `<li class="p-4 border rounded-lg ${i.isCorrect ? 'bg-green-50' : 'bg-red-50'}"><p class="text-sm text-gray-500 mb-1">${i.timestamp ? new Date(i.timestamp.seconds * 1000).toLocaleString('ja-JP') : ''}</p><p class="font-semibold mb-2">${i.japanese}</p><p>あなたの回答: <span class="font-normal text-gray-700">${i.userAnswer}</span></p><div class="p-2 mt-2 rounded ${i.isCorrect ? 'bg-green-100' : 'bg-red-100'}"><p class="text-sm font-medium">${i.isCorrect ? '✓ 正解' : '✗ 不正解'}: ${i.feedback}</p></div></li>`).join(''); }
        async function handleSubmit() { const userAnswer = dom.englishInput.value.trim(); if (!userAnswer) return; dom.submitBtn.disabled = true; dom.englishInput.disabled = true; dom.quizSection.classList.add('hidden'); dom.loadingScreen.classList.remove('hidden'); const question = activeSentences[currentQuestionIndex]; const result = await getAIEvaluation(question.ja, question.en, userAnswer); dom.loadingScreen.classList.add('hidden'); dom.quizSection.classList.remove('hidden'); renderResult(result); renderManualSrsControls(); playSound(result.isCorrect ? 'correct' : 'incorrect'); await addDoc(getCollectionRef('history'), { japanese: question.ja, userAnswer, ...result, timestamp: serverTimestamp() }); await updateQuestionSRS(question, result.isCorrect); dom.submitBtn.classList.add('hidden'); dom.nextBtn.classList.remove('hidden'); }
        function handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== ''); const newSentences = lines.map((line, i) => { const parts = line.split(','); if (parts.length < 2) throw new Error(`Error on line ${i + 1}: ${line}`); const ja = parts[0].trim(); const en = parts.slice(1).join(',').trim(); if (!ja || !en) throw new Error(`Error on line ${i + 1}: Empty part found.`); return { ja, en }; }); newSentences.forEach(s => {if(!allKnownSentences.has(s.ja)) { allKnownSentences.set(s.ja, s); }}); customSentences = newSentences; if (customSentences.length > 0) { dom.uploadStatus.textContent = `${customSentences.length}件を認識。学習を開始できます。`; dom.startCustomQuizBtn.disabled = false; updateStatsUI(); } else { throw new Error("No valid sentences found."); } } catch (error) { dom.uploadStatus.textContent = `ファイル形式エラー: ${error.message}`; dom.startCustomQuizBtn.disabled = true; } }; reader.readAsText(file); }

    </script>
</body>
</html>
